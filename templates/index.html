<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistant IQ • Chat UI</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
</head>
<body>
  <div class="app-shell">
    <!-- Desktop Sidebar -->
    <aside class="sidebar d-none d-lg-block">
      <div class="sidebar-header d-flex align-items-center justify-content-between px-3">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-stars fs-5 text-primary"></i>
          <strong>Assistant IQ</strong>
        </div>
        <button class="btn btn-sm btn-outline-secondary" id="newChatBtn"><i class="bi bi-plus-lg me-1"></i>New</button>
      </div>
      <div class="sidebar-body">
        <div class="p-3 pt-2">
          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input class="form-control" placeholder="Search chats" />
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-secondary">Recent Conversations</small>
            <button class="btn btn-link btn-sm p-0" id="clearHistory"><i class="bi bi-trash me-1"></i>Clear</button>
          </div>
          <div class="list-group list-group-flush" id="chatList">
            <!-- Example items -->
            <button class="list-group-item list-group-item-action d-flex gap-2 align-items-start">
              <i class="bi bi-chat-dots text-primary mt-1"></i>
              <div>
                <div class="small fw-semibold">API design for orders</div>
                <div class="small text-secondary">Updated 2m ago</div>
              </div>
            </button>
            <button class="list-group-item list-group-item-action d-flex gap-2 align-items-start">
              <i class="bi bi-chat-dots text-primary mt-1"></i>
              <div>
                <div class="small fw-semibold">Map search cost savings</div>
                <div class="small text-secondary">Yesterday</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Chat -->
    <main class="chat">
      <!-- Header -->
      <header class="chat-header d-flex align-items-center justify-content-between px-3">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-link d-lg-none p-0 me-1" data-bs-toggle="offcanvas" data-bs-target="#mobileNav" aria-controls="mobileNav">
            <i class="bi bi-list fs-4"></i>
          </button>
          <i class="bi bi-robot text-primary fs-5"></i>
          <div>
            <div class="fw-semibold">Assistant IQ</div>
            <small class="text-secondary">Ask anything — I’ll fetch answers from your backend</small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-outline-secondary" id="themeToggle" title="Toggle theme"><i class="bi bi-sun"></i></button>
          <button class="btn btn-sm btn-primary d-none d-sm-inline-flex" id="newChatBtn2"><i class="bi bi-plus-lg me-1"></i>New Chat</button>
        </div>
      </header>

      <!-- Body -->
      <section class="chat-body" id="chatBody">
        <div class="message-list" id="messageList">
          <!-- Example conversation -->
          <div class="msg bot">
            <div class="avatar"><i class="bi bi-robot"></i></div>
            <div>
              <div class="bubble">
                <div class="fw-semibold mb-1">Welcome to Assistant IQ</div>
                <div class="text-body">Ask me a question and I’ll get the answer from your API.
                  <ul class="mb-0 mt-2 small">
                    <li>Use the box below to type your question</li>
                    <li>Press <kbd>Enter</kbd> to send, <kbd>Shift</kbd>+<kbd>Enter</kbd> for a new line</li>
                  </ul>
                </div>
              </div>
              <div class="meta">Assistant • just now</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Composer -->
      <footer class="chat-composer">
        <form class="composer-inner" id="composer" autocomplete="off">
          <div class="d-flex align-items-end gap-2">
            <div class="flex-grow-1">
              <div class="form-floating">
                <textarea id="input" class="form-control autogrow" placeholder="Type your question..." rows="1"></textarea>
                <label for="input">Type your message…</label>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2 composer-toolbar">
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-secondary" type="button" title="Attach"><i class="bi bi-paperclip"></i></button>
                  <button class="btn btn-outline-secondary" type="button" title="Voice"><i class="bi bi-mic"></i></button>
                  <button class="btn btn-outline-secondary" type="button" title="Stop" id="stopBtn" disabled><i class="bi bi-stop"></i></button>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-secondary d-none d-sm-inline">Press Enter to send</small>
                  <button class="btn btn-primary" type="submit" id="sendBtn">
                    <span class="d-inline-flex align-items-center gap-2"><i class="bi bi-send"></i><span class="d-none d-sm-inline">Send</span></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </footer>
    </main>
  </div>

  <!-- Mobile Offcanvas -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileNavLabel">Conversations</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
      <div class="p-3">
        <button class="btn btn-outline-secondary w-100 mb-3" id="newChatBtnMobile"><i class="bi bi-plus-lg me-1"></i>New Chat</button>
        <div class="list-group list-group-flush" id="chatListMobile">
          <button class="list-group-item list-group-item-action d-flex gap-2 align-items-start">
            <i class="bi bi-chat-dots text-primary mt-1"></i>
            <div>
              <div class="small fw-semibold">Welcome</div>
              <div class="small text-secondary">Start a new chat</div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="status" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Something went wrong. Please try again.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div class="modal" tabindex="-1" id="confirmNewChat">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Start a new chat?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">This will clear the current conversation.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmNewChatBtn">New Chat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>

    const API_BASE = "/api";
    // Helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const chatBody = $('#chatBody');
    const messageList = $('#messageList');
    const input = $('#input');
    const composer = $('#composer');
    const sendBtn = $('#sendBtn');
    const stopBtn = $('#stopBtn');

    // Auto-grow textarea
    const autoGrow = () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 180) + 'px';
    };
    input.addEventListener('input', autoGrow);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        composer.requestSubmit();
      }
    });

    // Theme toggle
    const themeBtn = $('#themeToggle');
    themeBtn.addEventListener('click', () => {
      const html = document.documentElement;
      const next = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-bs-theme', next);
      themeBtn.innerHTML = next === 'dark' ? '<i class="bi bi-moon"></i>' : '<i class="bi bi-sun"></i>';
    });

    // Scroll to bottom
    const scrollToBottom = () => { chatBody.scrollTop = chatBody.scrollHeight; };

    // Render message
    function renderMessage(role, html, meta = 'just now') {
      const isUser = role === 'user';
      const wrapper = document.createElement('div');
      wrapper.className = `msg ${isUser ? 'user' : 'bot'}`;
      wrapper.innerHTML = `
        ${isUser ? '' : '<div class="avatar"><i class="bi bi-robot"></i></div>'}
        <div>
          <div class="bubble position-relative">
            <div class="msg-actions position-absolute top-0 end-0 p-2">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" title="Copy" onclick="navigator.clipboard.writeText(this.closest('.bubble').innerText)"><i class="bi bi-clipboard"></i></button>
              </div>
            </div>
            ${html}
          </div>
          <div class="meta">${isUser ? 'You' : 'Assistant'} • ${meta}</div>
        </div>
        ${isUser ? '<div class="avatar bg-primary text-white"><i class="bi bi-person"></i></div>' : ''}
      `;
      messageList.appendChild(wrapper);
      scrollToBottom();
      return wrapper;
    }

    // Typing placeholder (animated dots)
    function typingBubble() {
      const el = document.createElement('div');
      el.className = 'msg bot';
      el.innerHTML = `
        <div class="avatar"><i class="bi bi-robot"></i></div>
        <div>
          <div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>
          <div class="meta">Assistant • typing…</div>
        </div>`;
      messageList.appendChild(el);
      scrollToBottom();
      return el;
    }

    // Error toast
    const showError = (msg='Something went wrong. Please try again.') => {
      const toastEl = $('#errorToast');
      toastEl.querySelector('.toast-body').innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${msg}`;
      bootstrap.Toast.getOrCreateInstance(toastEl).show();
    };

    // Clear chat
    const newChatModal = new bootstrap.Modal('#confirmNewChat');
    const doNewChat = () => { messageList.innerHTML = ''; input.value = ''; autoGrow(); };
    $('#newChatBtn')?.addEventListener('click', () => newChatModal.show());
    $('#newChatBtn2')?.addEventListener('click', () => newChatModal.show());
    $('#newChatBtnMobile')?.addEventListener('click', () => newChatModal.show());
    $('#confirmNewChatBtn')?.addEventListener('click', () => { newChatModal.hide(); doNewChat(); });

    // Submit handler (connects to your backend)
    composer.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      // Show user message
      renderMessage('user', text);
      input.value = ''; autoGrow();

      // Show typing indicator
      const typing = typingBubble();
      stopBtn.disabled = false; sendBtn.disabled = true;

      try {
        
            const fd = new FormData();
            fd.append("question", text);
            fd.append("use_session_dirs", "false");
            fd.append("k", 5);
            fd.append("session_id", "");

            const res = await fetch(`${API_BASE}/chat/query`, { method: "POST", body: fd });
            if (!res.ok) {
                const err = await res.json().catch(()=>({detail:res.statusText}));
                throw new Error(err.detail || `HTTP ${res.status}`);
            }

            const json = await res.json(); // { answer, ... }
            const ans = extractAnswer(json) || "No answer.";

        // Demo fallback (remove in production)
        await new Promise(r => setTimeout(r, 900));

        typing.remove();
        renderMessage('bot', ans);
      } catch (err) {
        typing.remove();
        showError(err.message || 'Request failed');
      } finally {
        stopBtn.disabled = true; sendBtn.disabled = false; scrollToBottom();
      }
    });

    // Optional: Stop generation button (if you wire up streaming/cancel)
    stopBtn.addEventListener('click', () => {
      // Implement AbortController for fetch streaming and call abort() here
      showError('Stop not implemented in this template.');
    });

    // Maintain scroll shadows (optional)
    const onScroll = () => {
      const atTop = chatBody.scrollTop <= 0;
      const atBottom = chatBody.scrollHeight - chatBody.clientHeight - chatBody.scrollTop <= 1;
      chatBody.classList.toggle('scroll-shadow-top', !atTop);
      chatBody.classList.toggle('scroll-shadow-bottom', !atBottom);
    };
    chatBody.addEventListener('scroll', onScroll);
    onScroll();

    // Initialize textarea height
    autoGrow();


    function extractAnswer(response) {
    const fullAnswer = response.answer;
    
    // Split by </think> and take the part after it
    const parts = fullAnswer.split('</think>');
    
    if (parts.length > 1) {
        // Return the content after </think>, trimmed of whitespace
        return parts[1].trim();
    }
    
    // If no </think> tag found, return the full answer
    return fullAnswer;
}
  </script>
</body>
</html>
